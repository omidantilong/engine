import type { AstroIntegration, ViteUserConfig } from "astro"
import type { EngineDefaultRoutes } from "./types"
import fs from "fs-extra"
import replace from "@rollup/plugin-replace"

/*
This is a very simple example of an Astro integration injecting custom
routes. This is controlled by a config option, customIndex.

Setting it to false will use the integration slug route. 

Setting it to true will use the local slug route.

NOTE: IRL this engine integration would live inside node_modules. This
has no bearing on its functionality (in fact this is the exact same
approach that Starlight uses).

NOTE: Prior to Astro 5, Astro's routing logic would silently give
priority to injected routes, but would spit out multiple entry points
(files) for each match. That logic has changed and route collisions now
throw a warning (soon to be an error). To get around this, we can define
default routes in a function.

In the case where user wants local routes, customIndex is false and the
function is never called

In the case where user wants default routes, customIndex is true and
their local [...slug].astro shouldn't exist.

It would be cool if we could set build-time route priority info when
setting up `injectRoute`. But this seems to work fine for now, and
correctly outputs just one entry point when creating a build.


*/

const defaultRoutes: EngineDefaultRoutes = {
  "./src/pages/[...slug].astro": () => ({
    pattern: "[...slug]",
    entrypoint: "@omidantilong/engine/pages/[...slug].astro",
  }),
  "./src/pages/404.astro": () => ({
    pattern: "404",
    entrypoint: "@omidantilong/engine/pages/404.astro",
  }),
}

const engineIcon =
  '<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 48 48"><path fill="#fff" d="M43.5405684,37.052859 C43.9963193,35.4703316 44.2280702,33.8224105 44.2280702,32.15641 C44.2280702,30.4931022 43.9963193,28.8467197 43.5405684,27.2641924 C42.9433642,25.2850714 41.4865891,23.7302402 39.5449973,22.9993695 C37.6297585,22.3362005 35.6342982,22 33.6136475,22 C31.5914468,22 29.5979242,22.3362005 27.688886,22.9989848 C25.7399309,23.7325482 24.2831558,25.2869948 23.6921523,27.263423 C23.233301,28.8590291 23,30.5054116 23,32.15641 C23,33.8101011 23.233301,35.4580222 23.6917647,37.0524743 C24.2827682,39.0296719 25.7399309,40.5841184 27.6881109,41.3180665 C29.6002494,41.9808508 31.593772,42.3166667 33.6136475,42.3166667 C35.6315854,42.3166667 37.6274332,41.9808508 39.5438347,41.3184512 C41.4865891,40.5864265 42.9433642,39.0315952 43.5405684,37.052859 M43.5409434,15.052859 C43.9967026,13.4699469 44.2280702,11.8224105 44.2280702,10.15641 C44.2280702,8.49271748 43.9967026,6.84671974 43.5409434,5.26419235 C42.9433408,3.28507144 41.486539,1.7302402 39.5449118,0.99898484 C37.629638,0.33620052 35.6341413,-3.55271368e-15 33.6138413,-3.55271368e-15 C31.5916036,-3.55271368e-15 29.5980446,0.33620052 27.6889716,0.998600172 C25.7399809,1.73254822 24.2831792,3.28699479 23.6917774,5.26342302 C23.2329178,6.85902915 23,8.50502689 23,10.15641 C23,11.8101011 23.2329178,13.4576375 23.6913898,15.0524743 C24.2827916,17.0292872 25.7399809,18.5841184 27.6881965,19.3180665 C29.6003699,19.9808508 31.5939289,20.3166667 33.6138413,20.3166667 C35.631816,20.3166667 37.6273127,19.9808508 39.5437491,19.3184512 C41.486539,18.5864265 42.9433408,17.0312106 43.5409434,15.052859 M20.5409434,15.052859 C20.9967026,13.4699469 21.2280702,11.8224105 21.2280702,10.15641 C21.2280702,8.49271748 20.9967026,6.84671974 20.5409434,5.26419235 C19.9433408,3.28507144 18.486539,1.7302402 16.5449118,0.99898484 C14.629638,0.33620052 12.6341413,-7.10542736e-15 10.6138413,-7.10542736e-15 C8.59160361,-7.10542736e-15 6.59804463,0.33620052 4.68897163,0.998600172 C2.73998094,1.73254822 1.28317919,3.28699479 0.691777367,5.26342302 C0.232917758,6.85902915 -4.6753712e-12,8.50502689 -4.6753712e-12,10.15641 C-4.6753712e-12,11.8101011 0.232917758,13.4576375 0.691389816,15.0524743 C1.28279164,17.0292872 2.73998094,18.5841184 4.68819653,19.3180665 C6.60036993,19.9808508 8.59392891,20.3166667 10.6138413,20.3166667 C12.631816,20.3166667 14.6273127,19.9808508 16.5437491,19.3184512 C18.486539,18.5864265 19.9433408,17.0312106 20.5409434,15.052859 M37.2980783,12.7523083 C36.9611838,13.8036816 36.0710154,14.5892081 34.9754236,14.8023505 C34.4675385,14.900396 33.9443934,14.95 33.4216396,14.95 C32.8988857,14.95 32.3761319,14.900396 31.8678556,14.8023505 C30.7714811,14.5892081 29.8817041,13.8036816 29.5452008,12.7523083 C29.2998665,11.9807329 29.1754386,11.172342 29.1754386,10.35 C29.1754386,9.52727043 29.2998665,8.71887953 29.5452008,7.94769166 C29.8813128,6.89670598 30.7714811,6.11117944 31.8678556,5.89726201 C32.370654,5.79960404 32.8937991,5.75 33.4216396,5.75 C33.9502626,5.75 34.4726252,5.79960404 34.9754236,5.89726201 C36.0714067,6.11117944 36.9611838,6.89670598 37.2980783,7.94769166 C37.54263,8.72120472 37.6666667,9.52920809 37.6666667,10.35 C37.6666667,11.1700168 37.54263,11.9784078 37.2980783,12.7523083 Z M20.5409434,37.052859 C20.9967026,35.4699469 21.2280702,33.8224105 21.2280702,32.15641 C21.2280702,30.4927175 20.9967026,28.8467197 20.5409434,27.2641924 C19.9433408,25.2850714 18.486539,23.7302402 16.5449118,22.9989848 C14.629638,22.3362005 12.6341413,22 10.6138413,22 C8.59160361,22 6.59804463,22.3362005 4.68897163,22.9986002 C2.73998094,23.7325482 1.28317919,25.2869948 0.691777367,27.263423 C0.232917758,28.8590291 3.62561536e-10,30.5050269 3.62561536e-10,32.15641 C3.62561536e-10,33.8101011 0.232917758,35.4576375 0.691389817,37.0524743 C1.28279164,39.0292872 2.73998094,40.5841184 4.68819653,41.3180665 C6.60036993,41.9808508 8.59392891,42.3166667 10.6138413,42.3166667 C12.631816,42.3166667 14.6273127,41.9808508 16.5437491,41.3184512 C18.486539,40.5864265 19.9433408,39.0312106 20.5409434,37.052859 M14.2980783,34.7523083 C13.9611838,35.8036816 13.0710154,36.5892081 11.9754236,36.8023505 C11.4675385,36.900396 10.9443934,36.95 10.4216396,36.95 C9.89888573,36.95 9.37613191,36.900396 8.86785555,36.8023505 C7.77148114,36.5892081 6.88170405,35.8036816 6.54520084,34.7523083 C6.29986653,33.9807329 6.1754386,33.172342 6.1754386,32.35 C6.1754386,31.5272704 6.29986653,30.7188795 6.54520084,29.9476917 C6.88131277,28.896706 7.77148114,28.1111794 8.86785555,27.897262 C9.37065395,27.799604 9.89379906,27.75 10.4216396,27.75 C10.9502626,27.75 11.4726252,27.799604 11.9754236,27.897262 C13.0714067,28.1111794 13.9611838,28.896706 14.2980783,29.9476917 C14.54263,30.7212047 14.6666667,31.5292081 14.6666667,32.35 C14.6666667,33.1700168 14.54263,33.9784078 14.2980783,34.7523083 Z" transform="translate(2 3)"/></svg>'

//export function engine({ ...opts }: { output: "server" | "static" }): AstroIntegration {
export function engine(): AstroIntegration {
  //const astroConfig: AstroUserConfig = {}
  const viteConfig: ViteUserConfig = {}

  if (process.env.NODE_ENV === "production") {
    viteConfig.ssr = {
      noExternal: true,
      external: ["node:fs", "fs", "node:path", "react", "react-dom", "scheduler"],
    }
  }

  return {
    name: "engine",
    hooks: {
      "astro:route:setup": async ({ route }) => {
        if (route.component.endsWith(".md") || route.component.endsWith(".html")) {
          route.prerender = true
        }
      },
      "astro:config:setup": async ({
        injectRoute,
        addDevToolbarApp,
        updateConfig,
        addMiddleware,
      }) => {
        updateConfig({
          trailingSlash: "ignore",
          vite: {
            build: {
              rollupOptions: {
                plugins: [
                  replace({
                    preventAssignment: true,
                    "process.env.NODE_ENV": JSON.stringify("production"),
                  }),
                ],
              },
            },
            ssr: viteConfig.ssr || {},
          },
        })

        for (const route in defaultRoutes) {
          if (!fs.existsSync(route)) injectRoute(defaultRoutes[route]())
        }

        injectRoute({
          pattern: "/__engine__/update",
          entrypoint: "@omidantilong/engine/pages/api/update.ts",
        })

        addMiddleware({
          entrypoint: "@omidantilong/engine/middleware/middleware.ts",
          order: "pre",
        })

        addDevToolbarApp({
          id: "astro:engine",
          name: "Engine",
          icon: engineIcon,
          entrypoint: "@omidantilong/engine/toolbar/toolbar.ts",
        })
      },
    },
  }
}
